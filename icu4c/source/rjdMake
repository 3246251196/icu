#!/bin/bash --

which ppc-amigaos-gcc 1>/dev/null 2>&1 || { echo "ppc-amigaos-* binaries not found. Check your path" ; exit 1 ; }

if [[ "Linux" != $(uname) ]]
then
    echo "Expected the BUILD machine to be Linux"
    exit 1
fi

CROSS_BUILD_FULL_PATH=
CORES="$(nproc)"
INSTALL_PREFIX="$(pwd)/buildAmiga/installAmiga"

mkdir buildLinux
mkdir buildAmiga

pushd buildLinux
../runConfigureICU Linux/gcc || { echo "Error during BUILD-MACHINE configure" ; exit 1 ; }
CROSS_BUILD_FULL_PATH="$(pwd)"
make -j "$CORES" || { echo "Error during BUILD-MACHINE building" ; exit 1 ; }
popd

pushd buildAmiga
# default to linux
cp ../config/mh-linux ../config/mh-unknown
# __timezone hack
sed -i 's,#elif defined(__GLIBC__),#elif defined(__GLIBC__) \&\& !defined(__amigaos4__),g' ../common/putilimp.h
#
mkdir -p $INSTALL_PREFIX
# Just to make sure!
if [[ -z $INSTALL_PREFIX ]]
then
    echo "INSTALL_PREFIX must be set"
    exit 1
else
    rm -rf $INSTALL_PREFIX/*
fi
# Set "prefix" to the current directory
../configure \
    CC="ppc-amigaos-gcc" \
    CXX="ppc-amigaos-g++" \
    CPPFLAGS="-mcrt=clib2" \
    CXXFLAGS="-mcrt=clib2" \
    CFLAGS="-mcrt=clib2" \
    LDFLAGS="-mcrt=clib2 -athread=native" \
    --disable-tests --disable-samples --disable-shared --enable-static --disable-dyload --enable-release --disable-extras \
    --disable-debug \
    --host=ppc-amigaos \
    --with-cross-build="$CROSS_BUILD_FULL_PATH" \
    --prefix=$INSTALL_PREFIX || \
    	{ echo "Error during CROSS-MACHINE configure" ; exit 1 ; }
SUCC="successful"
THREADSCXXFLAGS=-athread=native make -j $CORES
if (( ${?} ))
then
    SUCC="not fully successful, but as much as possible was installed to $INSTALL_PREFIX"
fi
make install
popd

echo "###########################################################################"
echo "###########################################################################"
echo "Finished. See inside \"$INSTALL_PREFIX\". CROSS-MACHINE building was $SUCC."
echo "###########################################################################"
echo "###########################################################################"
exit 0
